---
dependency:
  name: galaxy
  enabled: true

driver:
  name: docker
platforms:
  - name: ol
    image: "quay.io/rendanic/docker-${MOLECULE_DISTRO:-ol8}-ansible:latest"
    pre_build_image: true
    # The following 4 lines are needed only for making systemd work
    command: ${MOLECULE_DOCKER_COMMAND:-""}
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - /vagrant:/vagrant:ro
    cgroupns_mode: host
    privileged: true

verifier:
  name: ansible

provisioner:
  name: ansible
  inventory:
    group_vars:
      all:
        configure_epel_repo: true
        configure_etc_hosts: false  # not supported inside docker
        configure_motd: false  # templates for motd uses ansible_facts with non existing values inside docker
        configure_ntp: false  # not supported inside a container
        disable_selinux: false  # not supported inside a container
        # device_persistence: ''

        oracle_sw_source_local: /vagrant
        apply_patches_db: true

        # special test with copy patches via www
        # is_sw_source_local: false
        # oracle_sw_source_www: http://10.0.2.15:8080

        db_homes_installed:
          - home: db19-si-ee
            state: present
            apply_patches: false  # patching is done in side-effect.yml!

        oracle_sw_patches:
          - filename: p35320081_190000_Linux-x86-64.zip
            patchid: 35320081
            version: 19.3.0.0
            description: Database Release Update 19.20.0.0.230718
          - filename: p35354406_190000_Linux-x86-64.zip
            patchid: 35354406
            version: 19.3.0.0
            description: OJVM RELEASE UPDATE 19.20.0.0.0
          - filename: p35512813_1920000DBRU_Generic.zip
            patchid: 35512813
            version: 19.3.0.0
            description: DATAPUMP BUNDLE PATCH 19.20.0.0.0
          - filename: p29213893_193000DBRU_Generic.zip
            patchid: 29213893
            unique_patchid: 22948049
            version: 19.3.0.0
            description: "DBMS_STATS FAILING WITH ERROR ORA-01422"
          - filename: p29213893_1915000DBRU_Generic.zip
            patchid: 29213893
            unique_patchid: 24722761
            version: 19.3.0.0
            description: "DBMS_STATS FAILING WITH ERROR ORA-01422"
          - filename: p29213893_1920000DBRU_Generic.zip
            patchid: 29213893
            unique_patchid: 25224952
            version: 19.3.0.0
            description: "DBMS_STATS FAILING WITH ERROR ORA-01422"

        db_homes_config:
          db19-si-ee:
            version: 19.3.0.0
            oracle_home: /u01/app/oracle/product/19/db19-si-ee
            edition: EE
            opatch_minversion: 12.2.0.1.36
            # imagename: db_home_19.15.zip
            opatch:
              - patchid: 35320081
                # Database Release Update 19.20.0.0.230718
                patchversion: 19.20.0.0.230718
                stop_processes: true
                state: present
              - patchid: 35354406
                # Oracle JavaVM Component Release Update (OJVM RU) 19.20.0.0.230718
                stop_processes: true
                state: present
              - patchid: 35512813
                # DATAPUMP BUNDLE PATCH 19.20.0.0.0
                stop_processes: false
                state: present

        oracle_listeners_config:
          LISTENER:
            home: db19-si-ee
            address:
              - host: "{{ ansible_hostname }}"
                protocol: TCP
                port: 1521

        listener_installed:
          - home: db19-si-ee
            listener_name: LISTENER
            state: present

        oracle_databases:
          - home: db19-si-ee
            oracle_db_name: &oracle_db_name DB1
            oracle_db_type: SI
            is_container: true
            storage_type: FS
            oracle_db_mem_totalmb: 1024
            oracle_database_type: MULTIPURPOSE
            redolog_size: 50M
            redolog_groups: 3
            datafile_dest: /u01/app/oracle/oradata
            recoveryfile_dest: /u01/app/oracle//fra
            listener_name: LISTENER
            listener_port: &cdb_listener_port 1521
            # *local_listener is used in initparam as an achor
            local_listener: &local_listener "{{ ansible_hostname }}:1521"
            archivelog: false
            flashback: false
            force_logging: true
            state: present
            statspack:
              purgedays: 14
              snaplevel: 7
              tablespace: PERFSTAT
              state: present
            tablespaces:
              - name: PERFSTAT
                size: 10M
                autoextend: true
                next: 50M
                maxsize: 4G
                content: permanent
                state: present
            init_parameters:
              - {name: db_create_file_dest, value: '/u01/app/oracle/oradata', scope: both, state: present}
              - {name: db_create_online_log_dest_1, value: '/u01/app/oracle/oradata', scope: both, state: present}
              - {name: recyclebin, value: 'off', scope: spfile, state: present}
              - {name: pga_aggregate_target, value: '128M', scope: both, state: present}
              - {name: sga_target, value: '1808M', scope: spfile, state: present, dbca: false}

        oracle_pdbs:
          - cdb: DB1
            home: db19-si-ee
            pdb_name: ORCLPDB
            listener_port: 1521
            state: present
            datafile_dest: /u01/app/oracle/oradata
            statspack:
              purgedays: 14
              snaplevel: 7
              tablespace: PERFSTAT
              state: present
            tablespaces:
              - name: PERFSTAT
                size: 10M
                autoextend: true
                next: 50M
                maxsize: 4G
                content: permanent
                state: present
